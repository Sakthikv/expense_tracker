<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Dashboard & Chatbot</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            overflow-x: hidden; /* Prevent horizontal overflow */
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2rem;
            color: #fff;
        }

        #container {
            display: flex;
            flex-direction: column; /* Stack the chart and chat on smaller screens */
            justify-content: space-between;
            align-items: stretch;
            width: 90%; /* Reduced width for better responsiveness */
            height: 70vh;
            background-color: #f5f5f5;
            border-radius: 10px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            padding: 10px;
            overflow: hidden; 
        }

        /* Media query for larger screens */
        @media (min-width: 600px) {
            #container {
                flex-direction: row; /* Side by side on larger screens */
            }
        }

        #chart-container, #chat-container {
            flex: 1;
            padding: 10px;
            box-sizing: border-box;
            background-color: #ffffff;
            border-radius: 10px;
            border: 2px solid #00796b;
            margin: 5px;
            overflow: hidden; /* Prevent content overflow within the containers */
        }

        #chart-container h3, #chat-container h3 {
            text-align: center;
            font-weight: bold;
            margin: 0;
        }

        #chat-container {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #chat-header {
            position: sticky;
            top: 0;
            background-color: #ffffff;
            padding: 10px;
            border-bottom: 2px solid #00796b;
            z-index: 1;
        }

        #chatbox {
            display: flex;
            flex-direction: column;
            height: calc(100% - 60px);
            box-sizing: border-box;
            margin-top: 10px;
            overflow-y: auto; /* Allow chatbox to scroll */
        }

        #user-input {
            position: relative;
            margin-top: auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            box-shadow: 0px -2px 4px rgba(0, 0, 0, 0.1);
            border-top: 2px solid #00796b;
        }

        #user-input textarea {
            flex: 1;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            resize: none;
            min-height: 50px;
        }

        button {
            background-color: #00796b;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            margin-left: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #004d40;
        }

        #chart {
            max-height: 100%;
            padding: 10px;
        }

        #chat-messages {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 10px;
        }

        .message {
            padding: 8px;
            margin: 5px 0;
            border-radius: 8px;
        }

        .user-message {
            background-color: #00796b;
            color: white;
            align-self: flex-end;
        }

        .bot-message {
            background-color: #ddd;
            color: black;
            align-self: flex-start;
        }
    </style>
</head>
<body>
    <h2>Financial Dashboard & Chatbot</h2>
    <div id="container">
        <div id="chart-container">
            <h3>Total Usage Chart</h3>
            <canvas id="chart"></canvas>
        </div>
        <div id="chat-container">
            <div id="chat-header">
                <h3>Financial Chatbot</h3>
            </div>
            <div id="chatbox">
                <div id="chat-messages"></div>
                <div id="user-input">
                    <textarea id="user-text" rows="1" placeholder="The graph shows your monthly expenses. You can ask for next month's predictions or any other financial ideas which will optimize your savings or provide updated expenses to improve your financial planning."></textarea>
                    <button id="send-button">Send</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const ctx = document.getElementById('chart').getContext('2d');
            let myChart = null;

            function updateChart(labels, data) {
                if (myChart) {
                    myChart.destroy();
                }
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Usage ($)',
                            data: data,
                            backgroundColor: 'rgba(0, 123, 255, 0.5)',
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            function fetchChartData() {
                fetch('/get_chart_data')
                    .then(response => response.json())
                    .then(data => {
                        console.log(data); // Debug: Log chart data to verify it's fetched correctly
                        if (data.months && data.usage) {
                            updateChart(data.months, data.usage);
                        } else {
                            console.error("Invalid chart data received", data);
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching chart data:", error);
                    });
            }

            fetchChartData();

            const sendButton = document.getElementById('send-button');
            const userInput = document.getElementById('user-text');
            const chatMessages = document.getElementById('chat-messages');

            function addMessage(content, isUser = true) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', isUser ? 'user-message' : 'bot-message');
                messageDiv.textContent = content;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            sendButton.addEventListener('click', function () {
                const userMessage = userInput.value;
                if (userMessage.trim()) {
                    addMessage(userMessage);
                    if (userMessage.toLowerCase().includes("visualization for the month of")) {
                        const month = userMessage.match(/month of (\w+)/i)[1]; // Extract month
                        fetch('/get_monthly_expense_summary', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ month: month })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.summary) {
                                // Update the chart with the individual spends for the month
                                const labels = Object.keys(data.summary);
                                const individualData = Object.values(data.summary);
                                updateChart(labels, individualData);
                                addMessage(`Hereâ€™s the visualization for ${month}:`);
                            } else {
                                addMessage(data.response, false);
                            }
                        });
                    } else if (userMessage.toLowerCase().includes("get back to the overall view")) {
                        fetchChartData(); // Fetch overall chart data
                        addMessage("Sure, now check out the overall view!");
                    } else {
                        fetch('/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ message: userMessage })
                        })
                        .then(response => response.json())
                        .then(data => {
                            addMessage(data.response, false);
                            if (data.response.includes("Thanks for your patience")) {
                                fetchChartData(); // Refresh chart after updating expenses
                            }
                        });
                    }
                }
                userInput.value = '';
            });

            userInput.addEventListener('keydown', function (event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendButton.click();
                }
            });
        });
    </script>
</body>
</html>
